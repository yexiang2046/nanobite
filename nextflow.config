params {
    cpus = 16
    // Input/Output
    sample_info = null          // Path to sample info file
    output_dir = "results"      // Output directory
    reference = null            // Reference genome path

    // Alignment parameters
    mm2opts = ""
    mm2opts_sr = "-ax sr"          // Minimap2 options for small RNA (short read preset)
    use_minimap2 = false           // Use minimap2 instead of BWA for small RNA alignment

    // RNA modification parameters
    min_coverage = 5            // Minimum coverage for modification calling
    prob_threshold = 0.8        // Probability threshold for modification calls
    
    // Region analysis
    regions_bed = null          // Path to BED file for specific regions
    generate_motif_regions = false // Whether to generate regions BED from motifs
    motif = "DRACH"            // Default motif for region generation
    
    // Modification types
    base_mods = "m,a,u"        // Modification types to analyze (m5C, m6A, pseU)

    // Quality filtering parameters
    min_qscore = 10            // Minimum Q score for read filtering

    // Basecalling parameters
    skip_basecalling = false   // Skip basecalling and start with BAM files
    bam_dir = null             // Directory containing basecalled BAM files (when skip_basecalling = true)
    use_fastq = false          // Output FASTQ from basecalling and run full pipeline (basecalling → FASTQ → alignment → quantification)

    // New parameter for GPU usage
    use_gpu = false
}

process {
    withName: 'MOD_BASECALLING' {
        container = 'ontresearch/dorado:latest'
        memory = '64 GB'
        cpus = 16
        containerOptions = { params.use_gpu ? '--gpus all' : '' }
    }

    withName: 'align' {
        container = 'staphb/dorado:0.9.0-cuda12.2.0'
        memory = '32 GB'
        cpus = 4
        containerOptions = '--gpus all'
    }
    
    withName: 'basecalling_rna' {
        container = 'staphb/dorado:0.9.0-cuda12.2.0'
        memory = '16 GB'
        cpus = 4
        containerOptions = '--gpus all'
    }

    withName: 'basecalling_small_rna' {
        container = 'staphb/dorado:0.9.0-cuda12.2.0'
        memory = '16 GB'
        cpus = 4
        containerOptions = '--gpus all'
    }

    withName: 'basecalling_pseU' {
        container = 'staphb/dorado:0.9.0-cuda12.2.0'
        memory = '32 GB'
        cpus = 8
        containerOptions = '--gpus all'
    }

    withName: 'RNA_MOD_ALL' {
        container = 'ontresearch/dorado:shae423e761540b9d08b526a1eb32faf498f32e8f22'
        memory = '64 GB'
        cpus = 16
        containerOptions = '--gpus all'
    }

    withName: 'RNA_MOD_M6A_DRACH' {
        container = 'ontresearch/dorado:shae423e761540b9d08b526a1eb32faf498f32e8f22'
        memory = '32 GB'
        cpus = 8
        containerOptions = '--gpus all'
    }

    withName: 'RNA_MOD_M5C' {
        container = 'ontresearch/dorado:shae423e761540b9d08b526a1eb32faf498f32e8f22'
        memory = '32 GB'
        cpus = 8
        containerOptions = '--gpus all'
    }

    withName: 'RNA_MOD_PSEU' {
        container = 'ontresearch/dorado:shae423e761540b9d08b526a1eb32faf498f32e8f22'
        memory = '32 GB'
        cpus = 8
        containerOptions = '--gpus all'
    }

    withName: 'RNA_MOD_INOSINE' {
        container = 'ontresearch/dorado:shae423e761540b9d08b526a1eb32faf498f32e8f22'
        memory = '32 GB'
        cpus = 8
        containerOptions = '--gpus all'
    }

    withName: 'RNA_MOD_C_2OME' {
        container = 'ontresearch/dorado:shae423e761540b9d08b526a1eb32faf498f32e8f22'
        memory = '32 GB'
        cpus = 8
        containerOptions = '--gpus all'
    }

    withName: 'RNA_MOD_A_2OME' {
        container = 'ontresearch/dorado:shae423e761540b9d08b526a1eb32faf498f32e8f22'
        memory = '32 GB'
        cpus = 8
        containerOptions = '--gpus all'
    }

    withName: 'RNA_MOD_U_2OME' {
        container = 'ontresearch/dorado:shae423e761540b9d08b526a1eb32faf498f32e8f22'
        memory = '32 GB'
        cpus = 8
        containerOptions = '--gpus all'
    }

    withName: 'RNA_MOD_G_2OME' {
        container = 'ontresearch/dorado:shae423e761540b9d08b526a1eb32faf498f32e8f22'
        memory = '32 GB'
        cpus = 8
        containerOptions = '--gpus all'
    }

    withName: 'filter_qscore' {
        container = 'quay.io/biocontainers/nanofilt:2.8.0--py_0'
        memory = '8 GB'
        cpus = 2
    }

    withName: 'bwa_align' {
        container = 'staphb/bwa:0.7.17'
        memory = '16 GB'
        cpus = 4
    }

    withName: 'minimap2_align' {
        container = 'staphb/minimap2:2.28'
        memory = '16 GB'
        cpus = 8
    }

    withName: 'minimap2_align_sr' {
        container = 'staphb/minimap2:2.28'
        memory = '16 GB'
        cpus = 4
    }

    withName: 'modkit_*' {
        container = 'quay.io/biocontainers/ont-modkit:0.5.0-2'
        memory = '60 GB'
        cpus = 16
    }

    withName: 'nanopack_plot' {
        memory = '32 GB'
        cpus = 8
        maxForks = 2
    }

    withName: 'nanopack_stats' {
        memory = '16 GB'
        cpus = 4
        maxForks = 3
    }

    withName: 'nanocount' {
        memory = '16 GB'
        cpus = 4
        maxForks = 3
    }

    // default
    withName: '.*' {
        memory = '60 GB'
        cpus = 16
    }

}

docker {
    enabled = true
    fixOwnership = true
    temp = 'auto'
}

// Resource management
executor {
    $local {
        cpus = 16
        memory = '64 GB'
    }
}

// Report generation
report {
    enabled = true
    file = "${params.output_dir}/pipeline_report.html"
}

timeline {
    enabled = true
    file = "${params.output_dir}/timeline.html"
}

trace {
    enabled = true
    file = "${params.output_dir}/trace.txt"
}

// Error handling
process.errorStrategy = 'retry'
process.maxRetries = 3

// Profiles
profiles {
    gpu {
        params.use_gpu = true
    }
    cpu {
        params.use_gpu = false
    }
}


